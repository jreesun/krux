# The MIT License (MIT)

# Copyright (c) 2021 Tom J. Sun

# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to deal
# in the Software without restriction, including without limitation the rights
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
# copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:

# The above copyright notice and this permission notice shall be included in
# all copies or substantial portions of the Software.

# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
# THE SOFTWARE.

#!/bin/bash
set -e

FIRMWARE_DIR="/src/firmware"
SCRIPTS_DIR="$FIRMWARE_DIR/scripts"
BUILD_DIR="$FIRMWARE_DIR/Kboot/build"

# From https://unix.stackexchange.com/a/634849
getdevice() {
    idV=${1%:*}
    idP=${1#*:}
    for path in `(find /sys/ -name idVendor | rev | cut -d/ -f 2- | rev) 2>/dev/null`; do
        if grep -q $idV $path/idVendor; then
            if grep -q $idP $path/idProduct; then
                (find $path -name 'device' | rev | cut -d / -f 2 | rev) 2>/dev/null
            fi
        fi
    done
}

panic() {
    printf "%s\n" "$1" >&2
    exit 1
}

if [ "$1" == "setup" ]; then
    docker build . -t krux-builder
elif [ "$1" == "build" ]; then
    device="$2"
    version="$3"
    locale="en-US"
    if [ ! -z "$4" ]; then
        locale="$4"
    fi
    
    printf "Signer Private Key (Leave empty to generate): "
    IFS= read -rs privkey
    printf "\n"
    if [ -z "$privkey" ]; then
        privkey_cmd="docker run --rm -w "$SCRIPTS_DIR" krux-builder python3 create_private_key.py"
        privkey=$($privkey_cmd)
    fi

    export SIGNER_PRIVKEY="$privkey"
    pubkey_cmd="docker run --rm -w "$SCRIPTS_DIR" --env SIGNER_PRIVKEY krux-builder python3 derive_public_key.py"
    pubkey=$($pubkey_cmd)
    export -n SIGNER_PRIVKEY
    unset SIGNER_PRIVKEY

    sed -i -- "s/SIGNER_PUBKEY = '.*'/SIGNER_PUBKEY = '$pubkey'/g" src/krux/metadata.py
    sed -i -- "s/VERSION = '.*'/VERSION = '$version'/g" src/krux/metadata.py

    docker build . -t krux-builder --build-arg DEVICE=$device --build-arg LOCALE=$locale

    export SIGNER_PRIVKEY="$privkey"
    sign_cmd="docker create -w "$SCRIPTS_DIR" --env SIGNER_PRIVKEY krux-builder python3 sign.py $BUILD_DIR/firmware.bin"
    CID=$($sign_cmd)
    docker start ${CID}
    docker wait ${CID}
    export -n SIGNER_PRIVKEY
    unset SIGNER_PRIVKEY

    docker cp ${CID}:$BUILD_DIR/firmware.bin "firmware-v${version}.bin"
    docker cp ${CID}:$BUILD_DIR/firmware.bin.sig "firmware-v${version}.bin.sig"
    docker cp ${CID}:$BUILD_DIR/firmware.bin.sha256.txt "firmware-v${version}.bin.sha256.txt"
    docker rm ${CID}

    if [ ! -z "$privkey_cmd" ]; then
        echo "Your generated Signer Private Key is below. Please write it down somewhere safe."
        echo $privkey
    fi
    unset privkey
elif [ "$1" == "flash" ]; then
    device="maixpy_m5stickv"
    if [ ! -z "$2" ]; then
        device="$2"
    fi

    device_vendor_product_id=""
    if [ "$device" == "maixpy_m5stickv" ]; then
        device_vendor_product_id="0403:6001"
        usb_device_name_cmd="getdevice $device_vendor_product_id"
        usb_device_name=$($usb_device_name_cmd)
        if [ -z "$usb_device_name" ]; then
            panic "Failed to find device via USB. Is it connected and powered on?"
        fi
        if [ -z "$device_vendor_product_id" ]; then
          panic "Unknown device"
        fi
        docker run --privileged --device=/dev/$usb_device_name:/dev/ttyUSB0 --rm -w "$BUILD_DIR" -it krux-builder python3 ktool.py -B goE -p /dev/ttyUSB0 -b 1500000 kboot.kfpkg
    fi

    if [ "$device" == "maixpy_bit" ]; then
        docker run --privileged --rm -w "$BUILD_DIR" -it krux-builder python3 ktool.py -B bit_mic -p /dev/ttyUSB0 kboot.kfpkg
    fi
    
elif [ "$1" == "clean" ]; then
    rm -rf build
    docker system prune --all --force
fi
